apiVersion: 1

groups:
  - orgId: 1
    name: koomky-alerts
    folder: Koomky
    interval: 1m
    rules:
      - uid: koomky_error_rate
        title: Error rate > 5%
        condition: A
        data:
          - refId: A
            datasourceUid: prometheus
            model:
              expr: (sum(rate(http_requests_total{status=~"5.."}[5m])) / clamp_min(sum(rate(http_requests_total[5m])), 0.0001)) > 0.05
              intervalMs: 60000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: API error rate above 5%
        labels:
          severity: critical

      - uid: koomky_latency_p95
        title: p95 latency > 500ms
        condition: A
        data:
          - refId: A
            datasourceUid: prometheus
            model:
              expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 0.5
              intervalMs: 60000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: API p95 latency above 500ms
        labels:
          severity: warning

      - uid: koomky_queue_depth
        title: Queue depth > 1000
        condition: A
        data:
          - refId: A
            datasourceUid: prometheus
            model:
              expr: sum(koomky_queue_jobs_waiting) > 1000
              intervalMs: 60000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: Queue depth above threshold
        labels:
          severity: critical

      - uid: koomky_disk_usage
        title: Disk usage > 80%
        condition: A
        data:
          - refId: A
            datasourceUid: prometheus
            model:
              expr: (100 - ((node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / clamp_min(node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}, 1)) * 100)) > 80
              intervalMs: 60000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 10m
        annotations:
          summary: Disk usage above 80%
        labels:
          severity: warning

      - uid: koomky_db_connections
        title: Database connections > 80
        condition: A
        data:
          - refId: A
            datasourceUid: prometheus
            model:
              expr: sum(pg_stat_database_numbackends) > 80
              intervalMs: 60000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: Database connections are high
        labels:
          severity: warning
